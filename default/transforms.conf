# default/transforms.conf
# ThreatER for Splunk App
#
# Combat-ready transforms:
# - Safe defaults
# - No automatic mutation
# - Opt-in only via props.conf
###############################################################################

###############################################################################
# HOST NORMALIZATION
# Use when ThreatER payloads contain a hostname / enforcer name
###############################################################################

[threater_set_host_from_enforcer]
SOURCE_KEY = _raw
REGEX = "\"enforcer_name\"\s*:\s*\"([^\"]+)"
FORMAT = host::$1
DEST_KEY = MetaData:Host
WRITE_META = true

[threater_set_host_from_device]
SOURCE_KEY = _raw
REGEX = "\"device_name\"\s*:\s*\"([^\"]+)"
FORMAT = host::$1
DEST_KEY = MetaData:Host
WRITE_META = true

###############################################################################
# INDEX ROUTING (OPTIONAL)
# Allows future routing by data type without touching inputs.conf
###############################################################################

[threater_route_events]
SOURCE_KEY = sourcetype
REGEX = ^threater:(block_event|unexpected_block)$
FORMAT = index::security_threater_events
DEST_KEY = _MetaData:Index

[threater_route_admin]
SOURCE_KEY = sourcetype
REGEX = ^threater:(command_log|user_activity)$
FORMAT = index::security_threater_admin
DEST_KEY = _MetaData:Index

###############################################################################
# SOURCETYPE HARDENING
# Useful if upstream ever breaks sourcetype consistency
###############################################################################

[threater_force_sourcetype_block_event]
SOURCE_KEY = _raw
REGEX = "\"event_type\"\s*:\s*\"block\""
FORMAT = sourcetype::threater:block_event
DEST_KEY = MetaData:Sourcetype

###############################################################################
# JSON SAFETY / DEFENSIVE CLEANUP
# Prevent accidental multiline breakage
###############################################################################

[threater_strip_control_chars]
SOURCE_KEY = _raw
REGEX = [\x00-\x08\x0B\x0C\x0E-\x1F]
FORMAT = 
DEST_KEY = _raw

###############################################################################
# FUTURE ENRICHMENT HOOKS (NO-OP UNTIL USED)
###############################################################################

[threater_extract_list_type]
SOURCE_KEY = _raw
REGEX = "\"type\"\s*:\s*\"(allow|block|threat)\""
FORMAT = list_type::$1
DEST_KEY = _meta

[threater_extract_policy_direction]
SOURCE_KEY = _raw
REGEX = "\"direction\"\s*:\s*\"(inbound|outbound)\""
FORMAT = policy_direction::$1
DEST_KEY = _meta

###############################################################################
# FALLBACK HOST SAFETY
# Ensures host is never empty (useful for dashboards)
###############################################################################

[threater_default_host]
SOURCE_KEY = host
REGEX = ^$
FORMAT = host::threater
DEST_KEY = MetaData:Host
WRITE_META = true
