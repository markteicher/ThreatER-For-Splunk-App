<form version="1.1">
  <label>Appliance Details</label>

  <description>
    Detailed view of a single ThreatER appliance.
  </description>

  <!-- ========================= -->
  <!-- APPLIANCE UUID (FROM PARENT OVERVIEW) -->
  <!-- ========================= -->
  <fieldset submitButton="false">
    <input type="text" token="appliance_uuid" required="true">
      <label>Appliance UUID</label>
    </input>
  </fieldset>

  <!-- ========================= -->
  <!-- GENERAL DETAILS -->
  <!-- ========================= -->
  <row>
    <panel>
      <table>
        <title>General</title>
        <search>
          <query>
            index=security_threater sourcetype=threater:appliance uuid="$appliance_uuid$"
            | table
                name
                uuid
                serialNumber
                registrationCode
                location
                chassis
                status
                networkStatus
                adminIP
          </query>
        </search>
        <option name="wrap">false</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- SOFTWARE -->
  <!-- ========================= -->
  <row>
    <panel>
      <table>
        <title>Software</title>
        <search>
          <query>
            index=security_threater sourcetype=threater:appliance uuid="$appliance_uuid$"
            | table
                softwareVersion
                updateStatus
                isUpToDate
                software.uuid
                software.family
                software.version
                software.buildNumber
                software.status
                software.releaseDatetime
                software.priority
          </query>
        </search>
        <option name="wrap">false</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- CONNECTIVITY (WITH DELTA) -->
  <!-- ========================= -->
  <row>
    <panel>
      <table>
        <title>Connectivity</title>
        <search>
          <query>
            index=security_threater sourcetype=threater:appliance uuid="$appliance_uuid$"

            | eval last_epoch = case(
                match(lastConnectedDatetime,"^\d{13}$"), round(tonumber(lastConnectedDatetime)/1000),
                match(lastConnectedDatetime,"^\d{10}$"), tonumber(lastConnectedDatetime),
                match(lastConnectedDatetime,"^\d{4}-\d{2}-\d{2}T"), strptime(lastConnectedDatetime,"%Y-%m-%dT%H:%M:%S%Z"),
                true(), null()
              )

            | eval age_sec = now() - last_epoch

            | eval "Connection Age" = case(
                age_sec < 3600, round(age_sec/60) . " minutes",
                age_sec < 86400, round(age_sec/3600) . " hours",
                age_sec < 604800, round(age_sec/86400) . " days",
                age_sec < 2592000, round(age_sec/604800) . " weeks",
                age_sec < 31536000, round(age_sec/2592000) . " months",
                true(), round(age_sec/31536000) . " years"
              )

            | eval "Connection Status" = case(
                age_sec < 3600, "ðŸŸ¢ Very Recent",
                age_sec < 86400, "ðŸŸ¢ Recent",
                age_sec < 604800, "ðŸŸ¡ Stale",
                age_sec < 2592000, "ðŸŸ  Old",
                true(), "ðŸ”´ Very Old"
              )

            | table
                throughputPercent
                lastConnectedDatetime
                "Connection Age"
                "Connection Status"
                hasDualBridging
          </query>
        </search>
        <option name="wrap">false</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- SUPPORT -->
  <!-- ========================= -->
  <row>
    <panel>
      <table>
        <title>Support</title>
        <search>
          <query>
            index=security_threater sourcetype=threater:appliance uuid="$appliance_uuid$"
            | table
                hasSupport
                supportEndsDatetime
          </query>
        </search>
        <option name="wrap">false</option>
      </table>
    </panel>
  </row>

  <!-- ========================= -->
  <!-- OWNERSHIP -->
  <!-- ========================= -->
  <row>
    <panel>
      <table>
        <title>Ownership</title>
        <search>
          <query>
            index=security_threater sourcetype=threater:appliance uuid="$appliance_uuid$"
            | table
                company.uuid
                company.name
                company.msp.uuid
                company.msp.name
          </query>
        </search>
        <option name="wrap">false</option>
      </table>
    </panel>
  </row>

</form>
