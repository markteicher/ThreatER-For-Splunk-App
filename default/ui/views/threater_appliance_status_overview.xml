<form version="1.1" theme="light">
  <label>ThreatER â€” Appliance Status Overview</label>

  <!-- ========= Header / Legend ========= -->
  <row>
    <panel>
      <html>
        <div style="font-size:16px;">
          <b style="font-size:18px;">ğŸ§° ThreatER Appliance Status Overview</b>
          <div style="margin-top:6px;">
            <b>Connectivity:</b>
            ğŸŸ¢ Connected recently &nbsp;Â·&nbsp;
            ğŸŸ¡ Stale &nbsp;Â·&nbsp;
            ğŸ”´ Disconnected
          </div>
          <div style="margin-top:6px;">
            <b>Network:</b>
            ğŸŒ UP &nbsp;Â·&nbsp;
            ğŸš« DOWN
          </div>
        </div>
      </html>
    </panel>
  </row>

  <!-- ========= Base Search ========= -->
  <search id="base_all">
    <query>
      index=security_threater sourcetype=threater:appliance_status

      | eval last_epoch = case(
          match(lastConnectedDatetime,"^\d{13}$"), round(tonumber(lastConnectedDatetime)/1000),
          match(lastConnectedDatetime,"^\d{10}$"), tonumber(lastConnectedDatetime),
          match(lastConnectedDatetime,"^\d{4}-\d{2}-\d{2}T"), strptime(lastConnectedDatetime,"%Y-%m-%dT%H:%M:%S%Z"),
          true(), null()
        )

      | eval age_sec = now() - coalesce(last_epoch, now())

      | eval ConnectionAge = case(
          age_sec < 3600, "ğŸŸ¢ less than 1 hour",
          age_sec < 86400, "ğŸŸ¢ less than 1 day",
          age_sec < 604800, "ğŸŸ¡ less than 1 week",
          age_sec < 2592000, "ğŸŸ¡ less than 1 month",
          true(), "ğŸ”´ over 1 month"
        )

      | eval NetworkBadge = case(
          networkStatus="UP", "ğŸŒ UP",
          networkStatus="DOWN", "ğŸš« DOWN",
          true(), "â“ UNKNOWN"
        )

      | eval StatusBadge = case(
          status="active", "ğŸŸ¢ Active",
          status="inactive", "ğŸŸ¡ Inactive",
          status="error", "ğŸ”´ Error",
          true(), "â“ Unknown"
        )

      | eval LastConnectedReadable = if(
          isnull(last_epoch),
          lastConnectedDatetime,
          strftime(last_epoch, "%Y-%m-%d %H:%M:%S %Z")
        )
    </query>
    <earliest>0</earliest>
    <latest>now</latest>
  </search>

  <!-- ========= Appliance Status Table ========= -->
  <row>
    <panel>
      <table>
        <title>Appliance Status Summary</title>
        <search base="base_all">
          <query>
            | table
                uuid
                name
                StatusBadge
                NetworkBadge
                ConnectionAge
                LastConnectedReadable
                message
          </query>
        </search>

        <option name="count">25</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">true</option>

        <!-- Drilldown to details -->
        <drilldown>
          <link target="_blank">
            threater_appliance_status_details.xml?form.appliance_uuid=$row.uuid$
          </link>
        </drilldown>
      </table>
    </panel>
  </row>

</form>
