<dashboard version="1.1">
  <label>Command Logs</label>

  <description>
    Audit log of user and system actions performed within ThreatER.
  </description>

  <fieldset submitButton="false">

    <input type="text" token="user_filter">
      <label>User</label>
    </input>

    <input type="text" token="module_filter">
      <label>Module</label>
    </input>

    <input type="text" token="action_filter">
      <label>Action</label>
    </input>

    <input type="dropdown" token="ui_filter">
      <label>UI Request</label>
      <choice value="">All</choice>
      <choice value="true">UI</choice>
      <choice value="false">API</choice>
    </input>

  </fieldset>

  <row>

    <panel>
      <title>UI vs API Usage</title>
      <chart>
        <search>
          <query>
index=security_threater sourcetype=threater:command_log
| spath
| eval request_type=if(isUiRequest==true,"UI","API")
| stats count by request_type
          </query>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>

    <panel>
      <title>Top Users by Actions</title>
      <table>
        <search>
          <query>
index=security_threater sourcetype=threater:command_log
| spath
| stats count AS actions by user
| sort - actions
| head 10
          </query>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
      </table>
    </panel>

  </row>

  <row>
    <panel>
      <title>Sensitive Actions Spotlight</title>
      <table>
        <search>
          <query>
index=security_threater sourcetype=threater:command_log
| spath
| eval action_lc=lower(action)
| where match(action_lc,"delete|disable|revoke|reset|remove|update|change")
| table datetime user module action message isUiRequest
| sort - datetime
          </query>
        </search>
        <option name="count">20</option>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>All Command Logs</title>
      <table>
        <search>
          <query>
index=security_threater sourcetype=threater:command_log
| spath
| eval
    user_lc=lower(user),
    module_lc=lower(module),
    action_lc=lower(action),
    is_ui_lc=lower(tostring(isUiRequest))
| where
    ( "$user_filter$"=="" OR like(user_lc,"%".lower("$user_filter$")."%") )
AND ( "$module_filter$"=="" OR like(module_lc,"%".lower("$module_filter$")."%") )
AND ( "$action_filter$"=="" OR like(action_lc,"%".lower("$action_filter$")."%") )
AND ( "$ui_filter$"=="" OR is_ui_lc="$ui_filter$" )
| table datetime user module action message isUiRequest
| sort - datetime
          </query>
        </search>
        <option name="count">25</option>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

</dashboard>
